# Обработка изображений на мобильных устройствах

© Бибиков С.А., к.т.н., доцент кафедры суперкомпьютеров и общей информатики, Самарский университет

## Лекция 4. Цветовые фильтры Байера. Дебайеризация

Содержание:

1. Различные технологии цветоделения.
2. Фильтр Байера.
3. Различные варианты цветовых фильтров.
4. Получение многоспектральных и гиперспектральных изображений.
5. Процесс дебайеризации (demosaicing).
6. Корректировка простых шумов типа salt & pepper.
7. Фильтрация скользящим окном.
8. Усреднение.
9. Медианная филтрация.
10. Интерполяция.

### 4.1 Различные технологии цветоделения

Полезные ссылки (дополняйте):

1. [Статья про массивы цветных светофильтров - wikipedia](https://ru.wikipedia.org/wiki/%D0%9C%D0%B0%D1%81%D1%81%D0%B8%D0%B2_%D1%86%D0%B2%D0%B5%D1%82%D0%BD%D1%8B%D1%85_%D1%81%D0%B2%D0%B5%D1%82%D0%BE%D1%84%D0%B8%D0%BB%D1%8C%D1%82%D1%80%D0%BE%D0%B2)
2. [Статья про Foveon X3-сенсор - science.fandom.com](https://science.fandom.com/ru/wiki/Foveon_X3-%D1%81%D0%B5%D0%BD%D1%81%D0%BE%D1%80)
3. [Статья про 3CCD-сенсор - science.fandom.com](https://science.fandom.com/ru/wiki/3CCD-%D1%81%D0%B5%D0%BD%D1%81%D0%BE%D1%80)

Принципы цветового зрения человка (трихроматизм) в техническом варианте требует разделения всего спектра оптического диапазона на 3 части. Осуществляется это деление обычно зв счет применения цветовых фильтров. При этом фильтр обладает пропускной способностью, определяемой его химическим составом и/или физическими свойствами, связанными с кристаллической решеткой. Кривые пропускной способности фильтра (обозначим их <img src="https://render.githubusercontent.com/render/math?math=r'(\lambda)">, <img src="https://render.githubusercontent.com/render/math?math=g'(\lambda)">, <img src="https://render.githubusercontent.com/render/math?math=b'(\lambda)">) совместно с кривой чувствительности сенсора (обозначим к примеру как <img src="https://render.githubusercontent.com/render/math?math=p(\lambda)">), примененные вместе к спектру регистрируемого света (<img src="https://render.githubusercontent.com/render/math?math=C(\lambda)">), после обработки выдают следующие значения на соответствующих элементах сенсоров:

<img src="https://render.githubusercontent.com/render/math?math=R=\int_380^720 C(\lambda)[r'(\lambda)p(\lambda)]d\lambda = \int_380^720 C(\lambda)\overline{r'}(\lambda)d\lambda">

<img src="https://render.githubusercontent.com/render/math?math=G=\int_380^720 C(\lambda)[g'(\lambda)p(\lambda)]d\lambda = \int_380^720 C(\lambda)\overline{g'}(\lambda)d\lambda">

<img src="https://render.githubusercontent.com/render/math?math=B=\int_380^720 C(\lambda)[b'(\lambda)p(\lambda)]d\lambda = \int_380^720 C(\lambda)\overline{b'}(\lambda)d\lambda">

Следует обратить внимание на то, что спектральные характеристики фильтров совместно с энергетической эффективностью (или чувствительностью) сенсоров вообще образуют свектральную чувствительность сенсора <img src="https://render.githubusercontent.com/render/math?math=\overline{r'}(\lambda)"> к определенному цвету. Это прямая техническая аналогия спектральной чувствительности колбочки человеческого глаза <img src="https://render.githubusercontent.com/render/math?math=\overline{r}(\lambda)"> из предыдущих лекций. При этом эти функции в общем случае различаются (<img src="https://render.githubusercontent.com/render/math?math=\overline{r'}(\lambda)\neq\overline{r}(\lambda)">), то есть в итоге цвет, который "видит" камера, и цвет, который видит глаз "стандартного наблюдателя", будут описываться разными наборами чисел. Поэтому и необходимы различные цветовые преобразования и переходы к стандартным цветовым пространствам.

Как же происходит разделение светового потока для сенсоров, обладающих разной спектральной чувствительностью? Существует несколько подходов: разделение светового потока на несколько раздельных сенсоров (3CCD-сенсор), разделение регистрирующих плоскостей сенсора в пространстве (Foveon X3-сенсор), разделение цветового потока в каждом элементарном сенсоре Nikon RGB-матрицы и самый распространенный способ - применение массивов цветных светочувствительных фильтров.

___3CCD-сенсор___ - устройство основывающееся на технологии получения цветного изображения применением трёх раздельных сенсоров и дихроидных призм, делящих поток лучей света на три пучка: RGB (красный, зелёный и синий). Каждый из этих пучков направляется на отдельную матрицу.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_04/images/l4_1.png" width="66%" title="Пример работы дихроической призмы"/>
  
  Рисунок 1 –  Пример работы дихроической призмы
</div>

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_04/images/l4_2.jpg" width="66%" title="Камера работающая на принципе разделения потоков дихроической призмой"/>
  
  Рисунок 2 –  Камера работающая на принципе разделения потоков дихроической призмой
  
</div>

___Преимущества___

1. Лучшая передача цветов изображения, полное отсутствие цветного муара.
2. Отсутствие необходимых для восстановления потерянной информации алгоритмов которые уменьшают эффективное разрешение.
3. Выше разрешающая способность (оптика). Отсутствует необходимый для устранения муара low-pass фильтр.
4. Выше светочувствительность и меньший уровень шумов благодаря отсутствию потерь в фильтрах.
5. Применение цветокоррекции установкой дополнительных фильтров перед отдельными матрицами. (не перед съёмочным объективом), что позволяет добиться существенно лучшей цветопередачи при нестандартных источниках света с сохранением высокой чувствительности системы в целом.
6. Имеется озможность повышения эффективного разрешения сверх разрешения отдельной матрицы вдвое по одной из координат, сдвинув три матрицы друг относительно друга на 1/3 пиксела и проведя интерполяцию трёх изображений с учётом этого сдвига. Данная технология получила наименование «Pixel shifting».

___Недостатки___
1. Принципиально бо́льшие габаритные размеры.
2. Трёхсенсорная система не может использоваться с традиционным зеркальным видоискателем, а также с объективами с малым рабочим отрезком (задним вершинным расстоянием).
3. В трёхсенсорной схеме есть проблема сведе́ния цветов. Такие системы требуют точной юстировки, причём чем большего размера матрицы применяются и чем больше их физическое разрешение, тем сложнее добиться необходимого класса точности.

___Foveon X3-сенсор___ - отличается цветоделением на аддитивные цвета RGB c использованием дисперсного свойства кремний-кремния поглощать «синие» , «зелёные» и « красные» составляющие лучи света на разной глубине фотодиода (в зависимости от разной длины волны — разной энергоемкости аналогового сигнала) в пределах одного пикселя.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_04/images/l4_3.webp" width="66%" title="Принцип работы Foveon X3"/>
  
  Рисунок 3 – Принцип работы Foveon X3
  
</div>

___Преимущества___

1. Изображение, которое даёт фотодатчик более натуральное, т.к. отпадает необходимость в интерполяции.
2. Отсутствие цветового муара — артефакта, характерного для мозаичных матриц.
3. По заявлению разработчиков фотодатчик Foveon Х3 имеет ещё одно свойство — простой бининг, изменяемый размер пикселя. Малый размер позволяет делать снимки высокого разрешения и качества. Больший — даёт возможность снимать при слабом освещении. При этом объединение сенсоров в пиксели может проводиться программно, без смены самой матрицы. Подобная технология изменения площади пикселя используется в матрицах компании Fujifilm.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_04/images/l4_4.webp" width="66%" title="Пример изображения снятого на Foveon X3"/>
  
  Рисунок 4 – Пример изображения снятого на Foveon X3
  
</div>

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_04/images/l4_5.jpg" width="66%" title="Пример цветового муара"/>
  
  Рисунок 5 – Пример цветового муара
  
</div>

___Недостатки___

1. Относительно высокий уровень цифрового шума, что объясняется влиянием верхних слоёв кремния на красный и зелёный слои фотодиода. 

___Nikon RGB-матрица___

Цветоделение на аддитивные цвета RGB производится дихроическими зеркалами внутри каждого пиксела, содержащего три фотодиода и одну микролинзу на весь пиксел.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_04/images/l4_6.webp" width="66%" title="Принцип работы Nikon RGB-матрицы"/>
  
  Рисунок 6 – Принцип работы Nikon RGB-матрицы
  
</div>

___Преимущества___

1. Отсутствие необходимости в дебайеризации, увеличение эффективного разрешения.

___Недостатки___

1. Очевидная высокая сложность и неоднородность сенсора.

Теперь перейдем к самой распространненной технологии цветоделения - применения массивов цветных светочувствительных фильтров. И начнем с ее самого известного варианта фильтра Байера.

### 4.2 Фильтр Байера

Фильтр Байера (шаблон Байера, паттерн Байера) — это двумерный массив цветных фильтров, которыми накрыты фотодиоды фотоматриц. Используется для получения цветного изображения в матрицах цифровых фотоаппаратов, видеокамер и сканеров. Фильтр Байера состоит из 25 % красных элементов, 25 % синих и 50 % зелёных элементов, расположенных как показано на рисунке.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_04/images/l4_7.png" width="66%" title="Фильтр Байера"/>
  
  Рисунок 7 – Фильтр Байера
  
</div>

Исторически это самый первый из массивов цветных фильтров. Назван по имени его создателя, доктора Брайса Э. Байера (англ. Bryce Bayer), сотрудника компании Kodak, запатентовавшего предложенный им фильтр в 1976 г. Для отличия от других разновидностей его называют GRGB, RGBG, или (если надо подчеркнуть диагональное расположение красного и синего пикселов) RGGB.
