# Обработка изображений на мобильных устройствах

© Бибиков С.А., к.т.н., доцент кафедры суперкомпьютеров и общей информатики, Самарский университет
© Сайгак Яна, студентка группы 6132

## Лекция 6. Точка белого. Автоматический баланс белого

Содержание:
1. Понятие точки белого
2. Цветовая температура источника света
3. Стандартные источники освещения
4. Коррекция точки белого в момент съемки
5. Ручной выбор эталона нейтрального цвета
6. Коррекция белого с точки зрения математики
7. Ретинекс
8. Серый мир
9. Метод главных компонент

### 6.1 Понятие точки белого

Как мы уже знаем, зрительная система человека обладает высокой адаптивностью к различным условиям наблюдения. Одним из важных механизмов такой адаптации является способность воспринимать цвета одинаково в разных условиях освещения. Этот механизм развивался эволюционно и решал задачи по одинаковому цвето восприятию в условиях яркого солнечного освещения, в условиях облачности или даже осадков, в различное время суток (на закате или при восходе Солнца). Видимо, важность одинакового восприятия цвета была достаточно высокой, это давало предкам человека определнные преимущества.

В технике свойство воспринимать цвета одинаково при различном освещении называется цветовым постоянством (color constancy). И если зрительная система человека в нормальном состоянии обладает этим свойством, то в технических системах необходимо осуществлять операцию, которая называется баланс белого.

__Баланс белого__ (ББ) – это процесс цветокоррекции, в результате которого объекты, которые глаз видит как белые, будут отображены белыми на снимке. ББ цифровой камеры должен учитывать цветовые характеристи («цветовую температуру») источника освещения, которая подразумевает относительную теплоту и холодность белого света. Наши глаза достаточно хорошо отличают белый при различных естественных (и это важно) источниках света, но для цифровых камер автоматический баланс белого (AWB) часто создает большие трудности. Например, неверный ББ может породить синюшные, восковые или даже трупно-зеленые оттенки у кожи, которые выглядят неестественно и особенно портят портреты. Применение ББ в традиционной пленочной фотографии означало использование различных оттеночных фильтров, каждый для определенных условий съемок, но в цифровой фотографии это больше требуется. Понимание цифрового ББ поможет избежать искажений цвета, вызванных внутренними алгоритмами обработки камеры, и тем самым повысить качество снимков при расширенном диапазоне условий освещения. 

Неверный баланс белого представлен на рисунке 1 слева. Корректный баланс белого представлен на рисунке 1 справа.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_06/images/l6_1.jpg" width="66%" title="Баланс белого (неправильный и правильный)"/>
  
  Рисунок 1 - Баланс белого (неправильный и правильный)
</div>

Так же можно встретить в литературе термин - __точка белого__. Это цвет объекта, который на конкретной фотографии, или в конкретных условиях освещения считается белым.

Помимо белого, в процессе могут учитываться и другие нейтральные цвета (оттенки серого от черного до белого). Но это обычно бывает излишним, считается, что в цветовом представлении все действительные нейтральные цвета объектов на изображении расположены на одной прямой линии между черным и белым. Однако нужно помнить, что это предположение может нарушаться, оно не гарантировано.

### 6.2 Цветовая температура источника света

Попытки описать естественные источники света привел к появлению такого термина как __цветовая температура__. Цветовая температура описывает спектр света, который испускает «абсолютно черное тело» в зависимости от температуры его поверхности. Абсолютно черным называется тело, которое поглощает любой падающий свет, ни отражая его, ни пропуская (и энергия этого света полностью переходит во внутреннюю энергию тела). И обратная ситуация - свет испускаемый абсолютно черным телом определяется температурой этого тела. Это конечно в определенной степени физическая абстракция, но примерным аналогом излучения абсолютно черного тела в быту может служить нагретый металл или камень: говорят, что они накалены (до "красного каления"), когда они достигают определенной температуры, и доведены до «белого каления» при значительно более высоких температурах. Аналогично, абсолютно черные тела при различных температурах покажут разную светимость, светимость различной цветовой температуры, разного спектра. Несмотря на название, свет, который может казаться белым, необязательно содержит полный видимый спектр.

Относительная интенсивность, которая нормализована для каждой температуры (в Кельвинах), представлена на рисунке 2.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_06/images/l6_2.png" width="66%" title="Относительная интенсивность, которая нормализована для каждой температуры (в Кельвинах)"/>
  
  Рисунок 2 - Относительная интенсивность, которая нормализована для каждой температуры (в Кельвинах)
</div>

Все естественные источники света (Солнце, огонь различной природы, раскаленные предметы, электрический разряд молнии) работают за счет испускания света из-за высокой собственной температуры. Помимо этого оказалось удобным описывать свет любых источников, даже не являющихся источниками как таковыми, через цветовую температуру. Через эту характеристику можно описать и свет от луны, и свет который нам дет ясное небо (области в полной тени освещаются именно небом), и пасмурное небо, затянутое тучами. Температура абсолютно черного тела в 5000 К (а это весьма близко к температуре на поверхности Солнца; ниже, потому что включается еще и действие атмосферы) соответствует примерно нейтральному свету - наиболее привычному для глаза человека с эволюционной точки зрения, тогда как температуры 3000 К (температура раскаленного железа) и 9000 К (уже область электрических разрядов) порождают свет, спектр которого смещен в оранжевую и синюю стороны, соответственно. При нарастании цветовой температуры распределение цвета становится более "холодным" (и тут включаются термины из фотографии, не обладающие с реальной физикой ничем общим, просто красное - горячее, а синее - холодное).

### 6.3 Стандартные источники освещения

Почему цветовая температура является полезным описанием света для фотографов, если они никогда не имеют дела с абсолютно черными телами? Такие источники света, как дневной свет или вольфрамовые лампы накаливания, создают спектр света, практически аналогичные светимостям абсолютно черных тел, хотя другие источники, такие как флуоресцентные или большинство продающихся энергосберегающих ламп, существенно от них отличаются. Поскольку фотографы никогда не используют термин «цветовая температура» применительно к настоящим абсолютно черным телам, этот термин подразумевает «коррелированную цветовую температуру», с соответствующей окраской источника света.

Таблица 1 демонстрирует коррелированную цветовую температуру некоторых распределенных источников света. 

| Цветовая температура | Источник света |
|---|---|
| 1000-2000 К |	Свечи |
| 2500-3500 К	| Лампа накаливания |
| 3000-4000 К | Восход и закат (чистое небо) |
| 4000-5000 К	| Флуоресцентные лампы |
| 5000-5500 К | Вспышка |
| 5000-6500 К | Дневной свет при чистом небе (солнце в зените) |
| 6500-8000 К | Умеренная облачность |
| 9000-10000 К | Тени и сильная облачность |

На рисунке 3 показано положение цвета источника в соответствии с его цветовой температурой.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_06/images/l6_3.png" width="66%" title="Цветовая температура и положение на хроматической плоскости"/>
  
  Рисунок 3 - Цветовая температура и положение на хроматической плоскости
</div>

### 6.4 Коррекция точки белого в момент съемки

Поскольку некоторые источники света не идентичны излучению абсолютно черных тел, баланс белого использует вторую переменную в дополнение к цветовой температуре: сдвиг зеленого, то есть отклонение от кривой на хроматической плоскости. Коррекция зеленого при обычном дневном свете чаще всего не нужна, однако при флуоресцентном и другом искусственном освещении баланс белого может потребовать значительной коррекции зеленого.

У большинства цифровых камер есть набор предустановок баланса белого, так что не нужно беспокоиться о цветовой температуре и сдвиге зеленого во время снимка.
Первые три варианта из таблицы 1 ориентированы на диапазоны цветовой температуры. Автоматический баланс белого доступен во всех цифровых камерах и использует алгоритм наилучшего приближения в ограниченном диапазоне – обычно между 3000/4000 К и 7000 К. Собственный баланс белого позволит сделать при заданном освещении снимок серого эталона и использовать его в качестве баланса белого для последующих снимков. «Kelvin» позволяет самостоятельно выбрать из широкого диапазона цветовой температуры. 
Следующие пять вариантов баланса белого из таблицы 1 перечислены в порядке увеличения цветовой температуры, хотя на многих компактных камерах баланс белого в тени не присутствует. У некоторых камер есть также настройка «галоген», которая рассчитана на работу с новыми флуоресцентными источниками освещения, откалиброванными по дневному свету.

В зависимости от времени дня, высоты или дымки может оказаться предпочтительнее вместо баланса белого для дневного света использовать ББ для облаков. Обычно, если на экране камеры изображение кажется слишком холодным (вне зависимости от параметров настройки), цветовую температуру можно быстро повысить, выбрав следующий элемент из таблицы 1 (на позицию ниже). Если изображение все еще слишком холодное (или теплое, при движении в противоположном направлении), возможно, будет разумнее задать температуру вручную в режиме.

Если ничего не помогает, и изображение по-прежнему имеет некорректный ББ впоследствии на компьютере, его можно скорректировать, чтобы вернуть цветам естественность. Камера выполняет согласно выбранным настройкам идентичную операцию - вычитает цвет источника освещения из цветов всех точек получаемого изображения. И вся процедура коррекции точки белого состоит из двух основных этапов: определение (или задание) цветности источника освещения и корректировка цветов на изображении. Как вы понимете, первый этап гораздо сложнее с точки зрения математики.

### 6.5 Ручной выбор эталона нейтрального цвета

Нейтральный эталон часто используют для важных относительно цвета снимков (например, портрет) или для ситуаций, когда автоматический баланс белого вызывает проблемы. Нейтральные эталоны могут являться частью сцены или могут быть принесены фотографом и использованы для калибровки камеры на предварительном этапе. На рисунке 4 представлен пример удачного эталона на сцене, которая в остальном наполнена закатной синевой.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_06/images/l6_4.jpg" width="66%" title="Пример удачного естественного эталона на изображении"/>
  
  Рисунок 4 - Пример удачного естественного эталона на изображении
</div>

Специально изготовленные портативные эталоны практически всегда являются более точными, поскольку человек может ошибиться, приняв за нейтральный по цвету предмет, который таковым не является. Идеальным эталоном серого (черного, белого) является тот, который отражает все цвета видимого спектра одинаково и сохраняет эту способность в широком диапазоне цветовой температуры. На рисунке 5 представлен пример одного из множества специально разработанных эталонов серого.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_06/images/l6_5.jpg" width="66%" title="Пример специально разработанного эталона серого"/>
  
  Рисунок 5 - Пример специально разработанного эталона серого
</div>

Для измерения цветовой температуры падающего или отраженного света могут также использоваться специальные приборы. Большинство нейтральных эталонов позволяют измерить отраженный свет, тогда как такие приборы, как измеритель баланса белого или «эксподиск» могут измерить падающий свет.

При последующей обработке изображений следует проявлять осторожность, применяя в качестве нейтрального эталона зашумленное изображение, поскольку, нажав на вроде бы серую область, можно в действительности выбрать цветовой пиксель, созданный шумом цветности. На рисунке 6 представлено зашумленное изображение.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_06/images/l6_6.png" width="66%" title="Зашумленные изображения"/>
  
  Рисунок 6 - Зашумленные изображения
</div>

Простым выходом в такой ситуации будет применение усреднения (размытия) изображения, для определения точных цветовых характеристик света.

### 6.6 Коррекция белого с точки зрения математики

Если рассматривать цвет источника света, то степень его влияния тем выше на цвет предмета, чем выше отражающая способность предмета. То есть чем выше яркость предмета на изображении, тем большее влияние оказывает цвет источника освещения, на абсолютно черный цвет освещение не оказывает вообще никакого влияиния. Эта зависимость считается линейной. Если рассматривать какое-нибудь привычное и понятное цветовое пространство, к примеру линейное RGB, то влияние цвета источника освещения будет выражаться в изменении направления линии черный-белый, на величину, соответствующую цвету освещения.

Предположим, что у нас есть изображение, зарегистрированное при нейтральном источнике освещения. Белый цвет как и положено имеет координаты (255; 255; 255). Добавление еще одного источника освещения добавит к этому цвету вектор. Если новый источник света обладает такими же цветовыми характеристиками что и основной, то у нас просто повысится яркость всего изображения. При этом (255; 255; 255) превратится например в (285; 285; 285), (127; 127; 127) станет (142; 142; 142), а (0; 0; 0) останется (0; 0; 0). При нормировке полученных значений от 0 до 255 мы получим значения соответсвующие исходному изображению.

Если источник обладает другими характеристиками, которые можно задать цветным вектором, то после нормировки мы получим эффект что весь куб цветов исказился и это искажение будет соответствовать повороту всего пространства цветов на определенный угол. Если у нас цвета на изображении не принимают экстремальных крайних значений около границ куба (а это довольно редко для естественных изображений), то это искажение может быть обращено, для этого нам нужно просто узнать куда повернулась наша бывшая "нормальная" линия черный-белый.

Это есть для построения такого поворота нам достаточно либо двух углов при условии неизменной общей яркости (три величины, определяющие вектор), либо только новых координат "искаженного" белого цвета (тоже три величины, задающие вектор).

Преобразование исправляющее в таких условиях все цвета изображения будет выглядеть как диагональная матрица:

<div align="center">
  <img src="https://latex.codecogs.com/gif.latex?\begin{matrix}%20\frac{255}{{{R}_{w}}}%20&%200%20&%200%20%20\\%200%20&%20\frac{255}{{{G}_{w}}}%20&%200%20%20\\%200%20&%200%20&%20\frac{255}{{{B}_{w}}}%20%20\\%20\end{matrix}" />
</div>

Это преобразование соответствует повороту всех цветов. То есть коррекции точки белого. Осталось только выяснить, какие именно значения можно использовать. Если на изображении есть нейтральные по цвету объекты, по крайней мере вы знаете, что они такими являются, то можно использовать координаты цвета для построения этой матрицы. При этом значения числителей в дробях должно соответствовать яркости этого объекта, например (127; 127; 127) для объекта, который должен быть 50% серым.

### 6.7 Теория Ретинекса

Теория ретинекса (англ. retinex theory; от retina — сетчатка и cortex — кора головного мозга) — теория цветовой константности зрения, сформулированная Эдвином Г. Лэндом в 1971 году.

Теория была сформулирована для объяснения независимости цветового восприятия от спектрального распределения энергии отраженного света. Лэнд предположил, что цветовое восприятие зависит от спектральных коэффициентов отражения поверхностей, а не от спектрального распределения отраженного света. Теория ретинекса — комбинации сетчаточных и корковых механизмов — оставляет неопределённость локализации данных процессов. Алгоритм вычисления выходного сигнала учитывает вариативность цветового ощущения при вариативности окружающего фона.

То есть воспринимаемый цвет определяется не столько спектральными характеристиками отраженного объектом света, сколько окружающими предметами и их цветом. Предполагалось, что знание зрителем существующих цветов может влиять на его восприятие. Чтобы показать, что не существует ключа для предсказания цвета, который будет увиден, Лэнд решил заменить привычные, естественные изображения окружающего мира абстрактной многоцветной мозаикой, представлявшей собой набор полосок цветной бумаги. Такого рода мозаики напоминали картины голландского художника Пита Мондриана, и Лэнд назвал их «цветными мондрианами». Для освещения изображения он использовал три проектора с возможностью регулировать мощность света с разными фильтрами: красный (длинноволновый), зеленый (средневолновый) и синий (коротковолновый). Используя мондрианы, Лэнд показал несколько поразительных вещей. Например, если отдельную цветную полоску (которую, к примеру, мы обычно видим зеленой) изолировать от окружающих цветов, она будет восприниматься как белая или как бледно-серая вне зависимости от того, какой луч света использовался для ее освещения. Лэнд показал, что такая полоска не может считаться прирожденно зеленой, а свой цвет она получает, взаимодействуя с окружающими ее зонами мондриана. В то время как, согласно классической теории Ньютона, цвет представлялся локальным и повсеместным и зависел от длины волны света, отраженной от каждой точки объекта, Лэнд показал, что цвет распределен не локально и не повсеместно, а зависит при наблюдении всей картины от восприятия цветов каждой точки объекта и цветового фона. При этом должны иметь место непрерывные связи, сравнение каждой части зрительного поля с его собственным окружением, чтобы получить глобальный синтез — по Гельмгольцу, совершить «акт суждения».

Многие слышали про споры о том, какого цвета платье на изображении: синее с черным, или золотое (желтое) с белым.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_06/images/l6_7.jpg" width="66%" title="Платье раздора"/>
  
  Рисунок 7 - Платье раздора
</div>

Попробуйте объяснить, в чем была причина споров.

Предложенная концепция Ретинекс используется в обработке изображения, для определения относительных значений цвета. Если переход от одного объекта в условиях действующего освещения оказывает определенный эффект на наблюдателя, то этот эффект должен сохраняться и при "идеальном" освещении. То есть применяя алгоритмы Ретинекса можно менять условия освещения, а значит корректировать точку белого.

Помимо этого, Ретинекс нашел свое применение в задачах устранения тени на изображениях.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_06/images/l6_8.jpg" width="66%" title="Устранение тени"/>
  
  Рисунок 8 - Устранение тени
</div>

Общая схема подхода достаточно простая: определяются разные области освещенности одного предмета согласно Ретинекс, определяется обрасть затенения и производится коррекция цветов в области затенения.

### 6.8 Серый мир

Еще одна интересная гипотеза используется для вычисления цвета освещения на изображении. Гипотеза (или предположение) Серого мира заключается в том, что на сбалансированном по цветам изображении среднее значение всех цветов является серым. Это действительно соответствует в некоторой степени механизмам зрения, так же не противоречит экспериментам по Ретинекс.

Цветовая компенсация в нашем мозге приводит к тому, что он старается минимизировать обрабатываемую информацию. Подстраивается под окружающую картину. Ведь источник освещения добавляет свой цвет условно всем наблюдаемым объектам, или по крайней мере большинству. Поэтому простейший вариант коррекции точки белого, согласно теории Серго Мира, заключается в вычислении среднего цвета изображения (именно цветовой составляющей, без яркости) и в вычитании этого среднего значения. Такая операция как раз и приближает суммарное цветовое ощущение к серому.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_06/images/l6_9.png" width="66%" title="Серый мир"/>
  
  Рисунок 9 - Серый мир
</div>

Этот алгоритм можно легко реализовать самостоятельно. Этот алгоримт является самым простым подходом к коррекции белого. Но не всегда срабатывает корректно. Особенно это касается цветов, которые находятся близко к границам цветового пространства.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_06/images/l6_10.jpg" width="66%" title="Серый мир"/>
  
  Рисунок 10 - Серый мир и его ошибки
</div>

Но чаще результат такой просто операции оказывается весьма впечатляющим.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_06/images/l6_11.png" width="66%" title="Серый мир и его победы"/>
  
  Рисунок 11 - Серый мир и его победы
</div>

### 6.9 Метод главных компонент

Еще один способ, который можно использовать для оценки источника освещения - метод главных компонент Ченга. В основе лежит та же идея о том, что цвет источника добавляется ко всем цветам на изображении. А если эта добавка существует, то она будет основной (главной) компонентой в разложении, если все цвета изображения рассмтаривать как вектора.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_06/images/l6_12_1.png" width="66%" title="Исходное изображение"/>
  
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_06/images/l6_12_2.png" width="66%" title="Исходное изображение"/>
  
  Рисунок 12 - Результат работы метода главных компонент
</div>

Перечисленные примеры можно самостоятельно получить по ссылке [пример для MatLab](https://www.mathworks.com/help/images/comparison-of-auto-white-balance-algorithms.html)

### 6.10 Автоматический баланс белого в камерах

Определенные предметы создают проблемы автоматическому балансу белого цифровой камеры даже при нормальном дневном свете. Одним из примеров является перенасыщенность одними тонами в связи с особенностями предмета съемки. На рисунке 13 представлено изображение, иллюстрирующее ситуацию, когда предмет преимущественно красный, и в результате камера воспринимает освещение, как теплое. Как следствие, камера пытается скомпенсировать теплоту, чтобы приблизить средний цвет изображения к нейтральному, но в результате создает синеву на камнях.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_06/images/l6_13.png" width="66%" title="Пример изображения, когда предмет преимущественно красный"/>
  
  Рисунок 13 - Пример изображения, когда предмет преимущественно красный
</div>

AWB цифровой камеры часто более эффективен, если на фото содержится хотя бы один белый или бесцветный яркий элемент. Без белой лодки на рисунке 14 внизу AWB цифровой камеры ошибочно создаст изображение с более теплой цветовой температурой.


<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_06/images/l6_14.jpg" width="66%" title="Изображение с более теплой цветовой температурой"/>
  
  Рисунок 14 - Изображение с более теплой цветовой температурой
</div>

__В смешанном свете__

Множественные источники света с разными цветовыми температурами могут еще более усложнить баланс белого. Некоторые ситуации могут вообще не иметь полностью корректного баланса белого, и тогда он будет зависеть от того, где точность цвета более важна. Пример такого изображения представлен на рисунке 15.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_06/images/l6_15.png" width="66%" title="Изображение, где точность цвета более важна"/>
  
  Рисунок 15 - Изображение, где точность цвета более важна
</div>

В смешанном свете AWB обычно подсчитывает среднюю цветовую температуру сцены в целом и далее использует ее для баланса белого. Обычно этот подход приемлем, однако AWB имеет тенденцию преувеличивать разницу цветовой температуры источников света относительно видимой глазами.

Чрезмерная разница в цветовой температуре часто наиболее заметна при смешении естественного и искусственного освещения. В некоторых случаях может также потребоваться независимый баланс белого для каждого освещения.

На рисунке 15 здание слева выглядит довольно теплым, тогда как небо, наоборот, несколько холодное. Это потому, что баланс белого был задан на основе лунного света – проявив цветовую температуру искусственного освещения. Баланс белого, основанный на естественном свете, часто создает более реалистичную фотографию.
