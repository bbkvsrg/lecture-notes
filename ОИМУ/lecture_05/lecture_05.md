# Обработка изображений на мобильных устройствах

© Бибиков С.А., к.т.н., доцент кафедры суперкомпьютеров и общей информатики, Самарский университет

## Лекция 5. Цветовые пространства. Переход между цветовыми пространствами

Содержание:

1. Определение цветового пространства
2. XYZ
3. Цветовой охват и диаграмма цветности
4. Переход между линейными простраствами
5. Семейство пространств RGB. Линейные и нелинейные пространства
6. Преобразование в Grayscale
7. HSL/HSV
8. CMYK
9. CIE Lab
10. Delta E. Эллипсы МакАдама
11. 

### Определение цветового пространства

Эксперименты CIE по определению "Стандартного наблюдателя" привели к возможности поставить в соответствие цветовому ощущению от света произвольного спектрального состава три числовых значения. Грубо говоря, появилась возможность описать все цвета в некотором трехмерном (три компоненты) пространстве. Исторически работу над этой проблемой начал еще в 19 веке Грассман, создав свои законы смешивания цветов.

Цветовое пространство — это определенная организация цветов. В сочетании с цветовым профилированием, поддерживаемым различными физическими устройствами, оно поддерживает воспроизводимые (повторимые) представления цвета, будь то аналоговое или цифровое представление.

При этом есть цветовые пространства заданные таблично (например шкала Pantone, где множеству цветов соответствуют числовые значения и иногда названия), есть пространства заданные модельно (например RGB, в котором цвет определялся яркостью свечения люминофоров в цветной лучевой трубке согласно построенной абстрактной математической модели).

### XYZ

В результате экспериментов CIE было определено пространство XYZ. Осями координат в этом пространстве являются отклики "стандартного наблюдателя", соответствующие, но не совпадающие с длинноволновым _L_ (красный), средневолновым _M_ (зеленый) и коротковолновым _S_ (синий) рецепторами человеческого глаза. 

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_1.png" width="33%" title="Представление пространства LMS"/>
  
  Рисунок 1 – Представление пространства LMS
</div>

Точке пересечения осей соответствует черный. При этом при высокой яркости человек теряет способность различать цвет и достаточно яркий зеленый все равно будет восприниматься как белый.

В модели CIE 1931 Y — это яркость, Z квазиравно синему, а X — это сочетание трех кривых CIE RGB.

Координаты XYZ и реальный спектр связаны достаточно сложно, в стандартном наблюдателе связь была определена только численно. Для модельной аппроксимации этой связи используются несколько функций.

<img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_2.svg" width="50%"/>

<img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_3.svg" width="66%"/>

<img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_4.svg" width="33%"/>

Пространство XYZ является самым старым цветовым пространством, оно и было выбрано в качестве промежуточного для всех возможных переходов и преобразований, универсальным пространством.

### Цветовой охват и диаграма цветности

Цветовое пространство CIE XYZ было специально разработано таким образом, что параметр Y также являлся мерой общей яркости цвета. ПРи этом цветность (красный или зеленый или фиолетовый или ...) определяется двумя производными параметрами x и y, причем два из трех нормализованных значений являются функциями всех трех трехцветных значений X, Y и Z:

<img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_5.svg" width="33%"/>

Полученная плоскость _xy_ называется диаграммой цветности.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_6.svg" width="66%" title="Диаграма цветности"/>
  
  Рисунок 2 – Диаграма цветности
</div>

Построенная диаграмма иногда называется "цветовой локус". по внешней криволинейной стороне расположены все чистые спектральные цвета, которые можно получить разложением белого цвета. Нижний прямолинейный отрезок соответствует смешанным цветам пурпура. Такого цвета в радуге не существует. Эта диаграма содержит все воспринимаемые человеком цвета, однако их невозможно передать ни через монитор, ни через печать на бумаге. Современные средства цветовоспроизведения не могут пока обеспечить этого.

На этой диаграме действуют и хорошо интерпретируются законы аддитивности Грассмана. Любые цвета, которые можно получить смешиванием двух исходных цветов, лежат на прямой соединяющей исходные цвета. Смешивая три цвета можно получить цвета лежащие внутри треугольника с вершинами в исходных цветах.

Эту диаграмму часто используют для иллюстрации цветового охвата, то есть цветов, которые могут быть учтены или воспроизведены в определенном цветовом пространстве или на физическом устройстве.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_6.svg" width="66%" title="Цветовой охват некоторых цветовых моделей"/>
  
  Рисунок 3 – Цветовой охват некоторых цветовых моделей
</div>

### Переход между цветовыми пространствами

Многие созданные для решения технических задач цветовые пространства получаются из пространства XYZ при помощи линейных преобразований. Это объясняется тем, что они в своей осное используют одинаковые законы физики, а именно линейную зависимость между мощностью сигнала и яркостью регистрируемого света. Это означает что во многих случаях переход из одного цветового пространства в другое можно осуществить с использованием линейных преобразований в виде матрицы. При этом обычно используется несколько допущений или ограничений. Черный цвет, как полное отстутсвие сигналов является общей точкой для всех таких цветовых пространств. Значит преобразование смещения в матрице отстутсвует. Остаются линейные преобразования поворота и масштабирования.

Матрица в данном случае будет иметь размерность 3х3. Операция преобразования цветов линейна, а значит теоретически полностью обратима. Однако при использовании реальных числовых представлений координат цвета часть информации может теряться из-за недостаточной точности (например при согранении 16 битного представления в 8 битное). Отсюда правило проводить все работы с цветом в числах с плавающей точкой и сохранять в итоговое предстовление только готовый результат.

Пример матрицы преобразования из пространства XYZ в пространство RGB.

