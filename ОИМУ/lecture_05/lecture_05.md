# Обработка изображений на мобильных устройствах

© Бибиков С.А., к.т.н., доцент кафедры суперкомпьютеров и общей информатики, Самарский университет

## Лекция 5. Цветовые пространства. Переход между цветовыми пространствами

Содержание:

1. Определение цветового пространства
2. XYZ
3. Цветовой охват и диаграмма цветности
4. Переход между линейными простраствами
5. Семейство пространств RGB. Преобразование в Grayscale
6. HSL/HSV
7. CMYK
8. CIE Lab. Дельта E. Эллипсы МакАдама


### 5.1 Определение цветового пространства

Эксперименты CIE по определению "Стандартного наблюдателя" привели к возможности поставить в соответствие цветовому ощущению от света произвольного спектрального состава три числовых значения. Грубо говоря, появилась возможность описать все цвета в некотором трехмерном (три компоненты) пространстве. Исторически работу над этой проблемой начал еще в 19 веке Грассман, создав свои законы смешивания цветов.

Цветовое пространство — это определенная организация цветов. В сочетании с цветовым профилированием, поддерживаемым различными физическими устройствами, оно поддерживает воспроизводимые (повторимые) представления цвета, будь то аналоговое или цифровое представление.

При этом есть цветовые пространства заданные таблично (например шкала Pantone, где множеству цветов соответствуют числовые значения и иногда названия), есть пространства заданные модельно (например RGB, в котором цвет определялся яркостью свечения люминофоров в цветной лучевой трубке согласно построенной абстрактной математической модели).

### 5.2 XYZ

В результате экспериментов CIE было определено пространство XYZ. Осями координат в этом пространстве являются отклики "стандартного наблюдателя", соответствующие, но не совпадающие с длинноволновым _L_ (красный), средневолновым _M_ (зеленый) и коротковолновым _S_ (синий) рецепторами человеческого глаза. 

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_1.png" width="33%" title="Представление пространства LMS"/>
  
  Рисунок 1 – Представление пространства LMS
</div>

Точке пересечения осей соответствует черный. При этом при высокой яркости человек теряет способность различать цвет и достаточно яркий зеленый все равно будет восприниматься как белый.

В модели CIE 1931 Y — это яркость, Z квазиравно синему, а X — это сочетание трех кривых CIE RGB.

Координаты XYZ и реальный спектр связаны достаточно сложно, в стандартном наблюдателе связь была определена только численно. Для модельной аппроксимации этой связи используются несколько функций.

<img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_2.svg" width="50%"/>

<img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_3.svg" width="66%"/>

<img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_4.svg" width="33%"/>

Пространство XYZ является самым старым цветовым пространством, оно и было выбрано в качестве промежуточного для всех возможных переходов и преобразований, универсальным пространством.

### 5.3 Цветовой охват и диаграма цветности

Цветовое пространство CIE XYZ можно интерпретировать более удобным способом. Для этого используется пространство xyY, в котором параметр Y является мерой общей светлости цвета (с этим термином очень много неясностей и различных синонимов и интерпретаций - яркость, светлота, объем). При этом цветность (красный или зеленый или фиолетовый или ...) определяется двумя производными параметрами x и y. Для получения координат в пространстве xyY значения определяются как функции трех трехцветных значений исходного пространства X, Y и Z:

<img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_5.svg" width="33%"/>

Если принять X + Y + Z = 1, то мы фактически стоим срез исходного пространства XYZ, соответствующий фиксированной светлости цвета. Получаем Y - значение по оси, перпендикулярной плоскости _xy_. Эта плоскость _xy_ называется диаграммой цветности.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_6.svg" width="66%" title="Диаграма цветности"/>
  
  Рисунок 2 – Диаграма цветности
</div>

Построенная диаграмма иногда называется "цветовой локус". по внешней криволинейной стороне расположены все чистые спектральные цвета, которые можно получить разложением белого цвета. Нижний прямолинейный отрезок соответствует смешанным цветам пурпура. Такого цвета в радуге не существует. Эта диаграма содержит все воспринимаемые человеком цвета, однако их невозможно передать ни через монитор, ни через печать на бумаге. Современные средства цветовоспроизведения не могут пока обеспечить этого.

На этой диаграме действуют и хорошо интерпретируются законы аддитивности Грассмана. Любые цвета, которые можно получить смешиванием двух исходных цветов, лежат на прямой соединяющей исходные цвета. Смешивая три цвета можно получить цвета лежащие внутри треугольника с вершинами в исходных цветах.

Эту диаграмму часто используют для иллюстрации цветового охвата, то есть цветов, которые могут быть учтены или воспроизведены в определенном цветовом пространстве или на физическом устройстве.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_7.png" width="66%" title="Цветовой охват некоторых цветовых моделей"/>
  
  Рисунок 3 – Цветовой охват некоторых цветовых моделей
</div>

### 5.4 Переход между цветовыми пространствами

Многие созданные для решения технических задач цветовые пространства получаются из пространства XYZ при помощи линейных преобразований. Это объясняется тем, что они в своей осное используют одинаковые законы физики, а именно линейную зависимость между мощностью сигнала и яркостью регистрируемого света. Это означает что во многих случаях переход из одного цветового пространства в другое можно осуществить с использованием линейных преобразований в виде матрицы. При этом обычно используется несколько допущений или ограничений. Черный цвет, как полное отстутсвие сигналов является общей точкой для всех таких цветовых пространств. Значит преобразование смещения в матрице отстутсвует. Остаются линейные преобразования поворота и масштабирования.

Матрица в данном случае будет иметь размерность 3х3. Операция преобразования цветов линейна, а значит теоретически полностью обратима. Однако при использовании реальных числовых представлений координат цвета часть информации может теряться из-за недостаточной точности (например при согранении 16 битного представления в 8 битное). Отсюда правило - проводить все работы с цветом в числах с плавающей точкой и сохранять в итоговое предстовление только готовый результат.

Пример матрицы преобразования из пространства XYZ в пространство RGB согласно [источнику](http://www.brucelindbloom.com/index.html?Eqn_RGB_XYZ_Matrix.html).

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_8.png" width="66%" title="Матрицы преобразования между пространствами sRGB и XYZ"/>
  
  Рисунок 4 – Матрицы преобразования между пространствами sRGB и XYZ
</div>

Для каждого цветового пространства определяются правила перевода цветов именно из/в XYZ, потому что XYZ - универсальное цветовое пространство. При этом переход должен осуществляться из линеаризованного пространства, т.е. перед таким переходом из RGB необходимо выполнить обратное гамма-преобразование.

Однако не все пространства являются линейными относительно XYZ. Например CIE Lab получается более сложными функциями, которые невозможно задать с помощью матрицы. Это определяется природой пространства. CIE Lab создавалось согласно другим принципам: пространство "моделирует" сигнал, приходящий в мозг в процессе зрения - разностный сигнал.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_9.png" width="25%" title="Преобразование из XYZ и CIE Lab"/>
  
  Рисунок 5 – Преобразование из XYZ и CIE Lab
</div>

### 5.5 Семейство пространств RGB

Самым распространенным семейством цветовых пространств на данный момент является семейство RGB. В это семейство входят различные варианты цветовых пространств основанных на одной модели и отличающихся деталями.


<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_10.svg" width="66%" title="Цветовой охват некоторых RGB пространств"/>
  
  Рисунок 6 – Цветовой охват некоторых RGB пространств
</div>

На рисунке изображены охваты некоторых цветовых пространств. Можно заметить, что некоторые пространства даже выходят за пределы видимых человеком цветов. Это обусловлено необходимостью использовать законы Грассмана и желанием ограничиться только 3 основными цветами, при этом охватить как можно больше отображаемых цветов для проведения корректных преобразований.

__Принципы построения RGB___

Здесь и далее подразумевается работа с линеаризованным представлением цвета, без применения гамма-преобразования, которое в обязательном порядке описано для RGB пространств. Основные принципы всем достаточно хорошо известны. Осями для пространств RGB являются яркости соответствующих элементов R, G, B. Эти яркости меняются от 0 до 1 и закодированы в соответствии с выбранным вариантом (если кодирование бинарное, мы получаем 3 битное изображение - вспомните самые старые компьютерные игры, если видели такие; современным стандартом является кодирование каждого канала в 8 бит, что дает 256 градаций на канал; для повышения точности при проведении цифровой обработки или при использовании чувствительных сенсоров применяется кодирование 16 бит на канал; существует несколько исторических вариантов, которые являются промежуточными для указанных). Яркости этих каналов изначально подразумевали интенсивность свечения элементов в устройстве отображенния (электронно лучевой трубке). 

Пространство RGB представляет собой куб. При смещении максимальных значений каждого канала мы получаем белый цвет, такие пространства называются аддитивными.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_11.svg" width="66%" title="Цветовой куб RGB пространства"/>
  
  Рисунок 6 – Цветовой куб RGB пространства
</div>

Основным различием представителей семейсва RGB между собой являются координаты точек, являющихся вершинами этого куба, в пространстве XYZ (а точнее на хроматической диаграмме xy). Эти же координаты определяют и цветовой охват получившегося пространства. Важной точкой является точка белого цвета (с координатами (1, 1, 1)). Ее положение на хроматической диаграмме xy тоже четко определено для каждого пространства и для каждого случая. Про точку белого мы поговорим на следующих занятиях.

__Преобразование в GrayScale из RGB__

Часто возникает техническая необходимость убрать цветовую информацию из изображения, превратив его в изображение в градациях серого (GrayScale). Градации серого в нашем понимании представлют собой значения яркости. Чем выше нинтенсивность свечения точки, тем выше должно быть значение яркости. Наивный подход подсказывает, что можно просто сложить значения каждого из каналов для одной точки и нормировать полученную сумму. Однако это не даст желаемого результата. Это объясняется тем, что каналы отвечают за свет разных длин волн, а разные длины воспринимаются по-разному. Помимо этого существуют природные компенсаторные механизмы человеческого глаза.

<div align="center">
  
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_12_1.jpg" width="33%" title="Исходное изображение"/>
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_12_2.jpg" width="33%" title="Прямое усреднение"/>
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_12_3.jpg" width="33%" title="Взвешенное усреднение"/>
  
  Рисунок 7 – Прямое усреднение каналов RGB и взвешенное усреднение
</div>

Веса для такого взвешенного усреднения следующие __0.2126 * R + 0.7152 * G + 0.0722 * B__. Напомню, что речь идет о линейных значениях, без гамма коррекции. То есть процесс преобразования выглядит так:

1. Обрабное гамма-преобразование исходного изображения.
2. Перевод в градации серого.
3. Прямое гамма-преобразование результирующего изображения.

Во многих цветовых пространствах для удобства использования интенсивность света (яркость, светлость и т.д.) выделены в отдельный канал. При этом два других канала отвечают за передачу цветности. При этом каналы, отвечающие за яркость, могут иметь немного отличный физический смысл, а коэффициенты отличаться от приведенных.

### 5.6 HSL/HSV пространства

Это скорее не само цветовое пространство, а способ описания цветов, т.е. цветовая модель.

HSV (англ. Hue, Saturation, Value — тон, насыщенность, значение) или HSB (англ. Hue, Saturation, Brightness — тон, насыщенность, яркость) — цветовая модель, в которой координатами цвета являются:
1. Hue — цветовой тон, (например, красный, зелёный или сине-голубой). Варьируется в пределах 0—360°, однако иногда приводится к диапазону 0—100 или 0—1.
2. Saturation — насыщенность. Варьируется в пределах 0—100 или 0—1. Чем больше этот параметр, тем «чище» цвет, поэтому этот параметр иногда называют чистотой цвета. А чем ближе этот параметр к нулю, тем ближе цвет к нейтральному серому.
3. Value (значение цвета) или Brightness — яркость. Также задаётся в пределах 0—100 или 0—1.

<div align="center">
  
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_13.png" width="45%" title="Цилиндр"/>
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_14.png" width="45%" title="Конус"/>
  
  Рисунок 8 – Цилиндрическое и конусообразное представление HSV/HSL
</div>

__Переход из RGB в HSV__

Довольно сложная в описании модель на деле рассчитывается достаточно быстро.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_15.png" width="66%" title="Переход из RGB в HSV"/>
  
  Рисунок 9 – Переход из RGB в HSV
</div>

Часто художники предпочитают использовать HSV вместо других моделей, таких как RGB и CMYK, потому что они считают, что устройство HSV ближе к человеческому восприятию цветов. RGB и CMYK определяют цвет как комбинацию основных цветов (красного, зелёного и синего или жёлтого, пурпурного, бирюзового и чёрного соответственно), в то время как компоненты цвета в HSV отображают информацию о цвете в более привычной человеку форме: Что это за цвет? Насколько он насыщенный? Насколько он светлый или тёмный? Цветовое пространство HSL представляет цвет похожим и даже, возможно, более интуитивно понятным образом, чем HSV.

HSL, HSV, HSI или родственные модели часто используются в компьютерном зрении и анализе изображений для обнаружения признаков или сегментации изображений. Приложения таких инструментов включают обнаружение объектов, например, в роботизированном зрении; распознавание объектов, например лиц, текста или номерных знаков; поиск изображений на основе контента; и анализ медицинских изображений.

По большей части алгоритмы компьютерного зрения, используемые на цветных изображениях, являются прямыми расширениями алгоритмов, разработанных для изображений в градациях серого, например, k-средние или нечеткая кластеризация цветов пикселей или хитрое обнаружение краев. В самом простом случае каждый цветовой компонент отдельно проходит по одному и тому же алгоритму. Поэтому важно, чтобы интересующие особенности можно было различить в используемых цветовых измерениях. Поскольку компоненты R, G и B цвета объекта в цифровом изображении коррелируют с количеством света, падающего на объект, и, следовательно, друг с другом, описание изображения с точки зрения этих компонентов затрудняет различение объектов. Описания в терминах оттенок/яркость/цветность или оттенок/яркость/насыщенность часто более уместны.

Начиная с конца 1970-х годов такие преобразования, как HSV или HSI, использовались как компромисс между эффективностью сегментации и вычислительной сложностью.

### 5.7 CMYK

Цветовая модель CMYK (также известная как триадный цвет или четырехцветная модель) представляет собой __субтрактивную__ цветовую модель, основанную на цветовой модели CMY, используемую в цветной печати, а также для описания самого процесса печати. CMYK относится к четырем красочным пластинам, используемым в некоторых видах цветной печати: голубому, пурпурному, желтому и ключевому (черному). Зачем нужен черный цвет? Проблема в том что смешивая три исходных цвета с максимальным покрытием, мы получим темно-грязно-коричневый и стоимость такого цвета будет очень высокой.


<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_16.png" width="66%" title="Модель CMY"/>
  
  Рисунок 10 – Модель CMY
</div>

Современные печатные процессы могут использовать гораздо большее количество красок, поэтому теоретическое описание всех вариантов цветопредставления при печати не имеет особого смысла. Ограничились четырьмя цветами. В описании указывается даже тип бумаги, на которой происходит печать. Каждый конкретный процесс печати требует тонкой настройки, чтобы обеспечить воспроизводимость.

### 5.8 CIE Lab

LAB — аббревиатура названия двух разных (хотя и похожих) цветовых пространств. Более известным и распространенным является CIELAB (точнее, CIE 1976 L*a*b*), другим — Hunter Lab (точнее, Hunter L, a, b). Таким образом, Lab — это неформальная аббревиатура, не определяющая цветовое пространство однозначно. Чаще всего, говоря о пространстве Lab, подразумевают CIELAB.

При разработке Lab преследовалась цель создания цветового пространства, изменение цвета в котором будет более линейным с точки зрения человеческого восприятия (по сравнению с XYZ), то есть с тем, чтобы одинаковое изменение значений координат цвета в разных областях цветового пространства производило одинаковое ощущение изменения цвета. Таким образом математически корректировалась бы нелинейность восприятия цвета человеком.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_17.jpg" width="66%" title="CIE Lab"/>
  
  Рисунок 11 – Пространство CIE Lab
</div>

ПО всем правилам CIE Lab это полноценное цветовое пространство соответствующее стандартному наблюдателю. Преобразование координат цветов из XYZ в CIE Lab является нелинейным и достаточно медленным.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_18.png" width="33%" title="Преобразование из XYZ в CIE Lab"/>
  
  Рисунок 12 – Преразование из XYZ в CIE Lab
</div>

В отличие от цветовых пространств RGB или CMYK, которые являются, по сути, набором аппаратных данных для воспроизведения цвета на бумаге или на экране монитора (цвет может зависеть от типа печатной машины, марки красок, влажности воздуха в цеху или производителя монитора и его настроек), Lab однозначно определяет цвет. Поэтому Lab нашёл широкое применение в программном обеспечении для обработки изображений в качестве промежуточного цветового пространства, через которое происходит конвертирование данных между другими цветовыми пространствами (например, из RGB сканера в CMYK печатного процесса). При этом особые свойства Lab сделали редактирование в этом пространстве мощным инструментом цветокоррекции.

Благодаря характеру определения цвета в Lab появляется возможность отдельно воздействовать на яркость, контраст изображения и на его цвет. Во многих случаях это позволяет ускорить обработку изображений, например, при допечатной подготовке. Lab предоставляет возможность избирательного воздействия на отдельные цвета в изображении, усиления цветового контраста, незаменимыми являются и возможности, которые это цветовое пространство предоставляет для борьбы с шумом на цифровых фотографиях.

__Дельта Е___

Основным преимуществом пространства является перцептуальная линейность. То есть если расстояние между двумя точками в просранстве увеличивается в два раза, то и ощущаемая человеком разница между соответствующими цветами тоже вырастет вдвое.

Именно поэтому одним из стандартных способов спрогнозировать или оценить ощущаемую человеком цветовую разность между двумя цветами является использование CIE Lab и специально рассчитываемой величины цветовой разности. Изначально, при создании CIE Lab, для определения цветовой разницы использовалось простое евклидово расстояние в пространстве.


с

С момента представления этого инструмента в 1976 году способ оценивания претерпел пару уточняющих редакций. Действующая сейчас величина называется CIEDE2000. Ее описание слишком сложно и нагружено чтобы держать его в голове. Там добавильось 7 корректирующих добавок в простую формулу. Это обусловлено недостаточно точным соответствием пространства процессу восприятия. Работы над совершенствованием теории цвета постоянно продолжаются.

__Эллипсы МакАдама__

Одним из представлений цветовой информации о пространствах и способах оценки являются эллипсы МакАдама. При изучении цветового зрения эллипс МакАдама представляет собой область на диаграмме цветности, которая содержит все цвета, неотличимые для среднего человеческого глаза от цвета в центре эллипса. Таким образом, контур эллипса представляет едва заметные различия цветности.

<div align="center">
  <img src="https://github.com/bbkvsrg/lecture-notes/blob/main/%D0%9E%D0%98%D0%9C%D0%A3/lecture_05/images/l5_21.png" width="33%" title="Эллипсы МакАдама"/>
  
  Рисунок 14 – Эллипсы МакАдама
</div>

Предполагалось, что в пространстве CIE Lab эллипсы МакАдама должны превратиться в идеальные окружности.
